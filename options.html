<html>
<head>
<title>Instapaper Options</title>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
var authstage=0;

//triggerError: Creates an error popup containing the input message
function triggerError(m) {
  $('#stat').slideUp(function() {
    $('#stat')
      .text(m)
      .css('color','#F00')
      .slideDown();
  });
}

//auth: Retrieves user/pass from localStorage and returns authentication status to input function
function auth(func) {
  $.ajax({
    'method':'post',
    'cache':0,
    'url':'https://www.instapaper.com/api/authenticate',
    data:{
      'username':localStorage['un'],
      'password':localStorage['pw'],
      'random':(new Date()).getTime()
    },
    complete:function(d) {
      switch(d.status) {
        case 200:
          //Success
          localStorage['au']=1;
          $('#authname').text(localStorage['un']);
          $('#stat').slideUp(function() {
            $('#stageauth').fadeOut(function() {
              $('#stageopts,#userpane').fadeIn();
            });
          });
          break;
        case 400:
          //Server Refused
          triggerError('Instapaper Server refused to process request. Try again later');
          break;
        case 403:
          //Fix Authentication
          $('#stat').slideUp(function() {
            $('#sendauth').attr('disabled',0);
            if(authstage==1) {
              $('#msgauth')
                .css('color','#F00')
                .text('Please verify your credentials and try again');
              $('#pass').focus();
            }
            else if(authstage==2) {
              $('#authpass').css('display','block');
              $('#msgauth')
                .css('color','#F00')
                .text('Your Instapaper credentials are invalid');
              $('#user').val(localStorage['un']);
              $('#stageauth').fadeIn();
              $('#pass').focus();
              authstage=1;
            }
            else {
              authstage=1;
              $('#authpass').slideDown();
              $('#msgauth').text('Now enter your password');
              $('#pass').focus();
            }
          });
          break;
        case 404:
          //Internet Error
          triggerError('Could not connect to server. Please check your connection to www.instapaper.com');
          break;
        case 500:
          //Server Error
          triggerError('The remote server encountered an error. Please try again later.');
          break;
        default:
          triggerError('Could not connect to server. Please check your connection to www.instapaper.com');
      }
    }
  });
}

$(document).ready(function() {
  $('#formauth').submit(function(e) {
    e.preventDefault();
    $('#sendauth').attr('disabled',1);
    localStorage['un']=$('#user').val();
    localStorage['pw']=$('#pass').val();
    $('#pass').val('');
    auth();
  });
  
  $('#clear').click(function(e) {
    e.preventDefault();
    
    authstage=0;
    $('#msgauth')
      .css('color','#000')
      .text('Welcome! Please enter your username:');
    $('#authpass').css('display','none');
    
    $('#userpane').fadeOut();
    $('#stageopts').fadeOut(function() {
      $('#stageauth').fadeIn();
      $('#user').val('').focus();
    });
    $('#sendauth').attr('disabled',0);

    localStorage['un']=0;
    localStorage['pw']=0;
    localStorage['au']=0;
  });
  
  $('.opt').each(function() {
    $(this).attr('checked',eval(localStorage[$(this).attr('id')]));
  });
  $('#save').attr('disabled',1);
  
  $('.opt').change(function() {
    $('#save').attr('disabled',0);
    $('#save').val('Save');
  });
  
  $('#save').click(function() {
    $('.opt').each(function() {
      localStorage[$(this).attr('id')]=$(this).attr('checked');
    });
    
    $('#save').attr('disabled',1);
    $('#save').val('Saved');
  });
  
  if(localStorage.getItem(['sk'])!=null) {
    $('#exp_ksk').css('display','block');
  }
  
  chrome.extension.sendRequest({
    'task':'getExtras'
  },function(x) {
    var k=0;
    for(i in x) {
      k++;
      $('<tr />')
        .append($('<td />')
          .append($('<a />')
            .attr({
              'href':x[i]['link'],
              'target':'_blank'
            })
            .text(x[i]['name'])
          )
        )
        .append($('<td />')
          .text(i)
        )
        .appendTo('#extras');
    }
    if(k>0) {
      $('#box_extras').css('display','block');
    }
  });
  
  if(localStorage['au']!='1') {
    //New User Screen
    $('#stageauth').css('display','block');
    $('#user').focus();
  }
  else {
    //Verify Credentials
    $('#stat').slideDown();
    authstage=2;
    setTimeout(auth,1000);
  }
});
</script>
<link rel="stylesheet" href="styles.css" />

</head>
<body>
<div id="body">
<div id="header">
  <div id="userpane">
  Hello, <span id="authname"></span>.
  <a href="#" id="clear">Log out</a>
  </div>
  <h1 id="logo">Instapaper Extension</h1>
</div>
<div id="auditorium">
  <div id="stat">
    Verifying your Instapaper credentials...
  </div>
  <div class="stage" id="stageauth">
    <div id="msgauth">Welcome! Please enter your username:</div><br />
    <form id="formauth">
    
    <table border="0" cellspacing="0" cellpadding="0">
    <tr><td style="width:100px;"><label for="user">Username:</label></td>
    <td><input type="text" id="user" name="user" /></td>
    </tr></table>
    
    <div id="authpass"><table border="0" cellspacing="0" cellpadding="0">
    <tr><td style="width:100px;"><label for="pass">Password:</label></td>
    <td><input type="password" id="pass" name="pass" /></td>
    </tr></table></div>
    
    <br /><input type="submit" id="sendauth" value="Continue" />
    </form>
  </div>
  <div class="stage" id="stageopts">
    <div>Instapaper Options</div>
    <br /><b>Browser Button</b><br />
    <input type="checkbox" id="opt_text" class="opt" />
    <label for="opt_text">Open text view on save</label><br />

    <input type="checkbox" id="opt_close" class="opt" />
    <label for="opt_close">Close original tab on save</label><br />

    <br /><b>Context Menu</b><br />
    <input type="checkbox" id="opt_notif" class="opt" />
    <label for="opt_notif">Autoclose save notifications</label><br />
    
    <div id="exp_ksk" class="exp">
    <br /><b>Experimental</b><br />
    <input type="checkbox" id="opt_ksk" class="opt" />
    <label for="opt_ksk">Automatically Send to Kindle</label><br />
    </div>
    
    <div id="box_extras">
    <br /><b>Extras</b><br />
    <table id="extras" border="0" cellspacing="0" cellpadding="0">
    <tr><td>Name</td><td>ID</td></tr>
    </table>
    </div>

    <br /><input type="button" id="save" value="Saved" disabled="disabled" /><br />
  </div>
</div><br /><br /><br />
<div id="footer">
  <form action="https://www.paypal.com/cgi-bin/webscr" method="post">
  <input type="hidden" name="cmd" value="_s-xclick">
  <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
  ">
  <input type="image" src="donate.png" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
  <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
  </form>

  <a target="_blank" href="welcome.html">Message Center</a>
  &nbsp;&bull;&nbsp;
  <a target="_blank" href="https://chrome.google.com/webstore/detail/bbmelbhnoccdkjiblgchdaofjdbombmh">Chrome Web Store Page</a>
  &nbsp;&bull;&nbsp;
  <a target="_blank" href="https://github.com/jamesmkwan/Instapaper">Extension Source Code</a>
  &nbsp;&bull;&nbsp;
  <a target="_blank" href="http://jamesmkwan.com/">Developer's Website</a>
  <div style="margin-top:1em;">
  This extension uses the Instapaper API but is not endorsed or certified by Instapaper. <br /><br />
  &copy; 2011 James Kwan
</div>
</div>
</body>
</html>